# 数据库迁移执行顺序指南

## 概述

本文档详细说明了TodoList项目数据库迁移文件的正确执行顺序，以及每个迁移文件的作用和注意事项。

## 迁移文件执行顺序

### 新项目初始化

对于全新的项目，请按以下顺序执行：

1. **初始化脚本**
   ```sql
   -- 执行文件：db/init/00_initial_setup.sql
   -- 作用：创建所有基础表结构、RLS策略和索引
   -- 状态：已同步实际数据库状态，移除了不存在的函数和触发器
   ```

### 现有项目更新

对于已有数据库的项目，请按版本号顺序执行迁移：

1. **V1 - 修复teams表SELECT策略**
   ```sql
   -- 执行文件：db/migrations/V1_HOTFIX__fix_teams_select_policy_correct.sql
   -- 作用：修复teams表的SELECT策略，确保用户能看到自己创建和参与的团队
   -- 状态：已测试，可安全执行
   ```

2. **V5 - 完整RLS策略重建**
   ```sql
   -- 执行文件：db/migrations/V5_COMPLETE_FIX__enable_rls_and_policies.sql
   -- 作用：全面重建所有表的RLS策略，确保数据安全性
   -- 状态：已测试，解决了大部分权限问题
   ```

## 迁移文件详细说明

### 初始化文件

#### `db/init/00_initial_setup.sql`
- **用途**：新项目的完整数据库初始化
- **包含内容**：
  - 表结构创建（teams, team_members, todos）
  - 行级安全策略（RLS）
  - 性能优化索引
  - 辅助函数
- **特点**：基于实际数据库状态同步，移除了不存在的函数和触发器
- **执行条件**：仅在全新数据库中执行

### 迁移文件

#### `V1_HOTFIX__fix_teams_select_policy_correct.sql`
- **版本**：V1
- **类型**：紧急修复
- **问题**：用户无法看到自己创建的团队
- **解决方案**：重新创建teams表的SELECT策略
- **影响范围**：teams表的查询权限
- **回退方案**：可通过删除策略并重新创建来回退

#### `V5_COMPLETE_FIX__enable_rls_and_policies.sql`
- **版本**：V5
- **类型**：全面修复
- **问题**：RLS策略不完整或不正确
- **解决方案**：
  - 确保所有表启用RLS
  - 清理所有现有策略
  - 重建完整的RLS策略体系
- **影响范围**：所有表的所有操作权限
- **特点**：包含完整的验证脚本

## 执行前检查清单

### 环境准备
- [ ] 确认Supabase项目已创建
- [ ] 确认数据库连接正常
- [ ] 备份现有数据（如果有）
- [ ] 确认执行权限

### 执行中监控
- [ ] 逐个执行SQL语句块
- [ ] 检查每个步骤的执行结果
- [ ] 注意NOTICE和ERROR消息
- [ ] 验证策略创建成功

### 执行后验证
- [ ] 检查表结构是否正确
- [ ] 验证RLS是否启用
- [ ] 测试基本CRUD操作
- [ ] 验证权限控制是否正常

## 常见问题和解决方案

### 问题1：策略创建失败
**症状**：`CREATE POLICY` 语句执行失败
**原因**：可能存在同名策略或语法错误
**解决方案**：
```sql
-- 先删除可能存在的策略
DROP POLICY IF EXISTS "策略名称" ON 表名;
-- 然后重新创建
```

### 问题2：RLS未启用
**症状**：策略创建成功但不生效
**原因**：表的RLS未启用
**解决方案**：
```sql
ALTER TABLE 表名 ENABLE ROW LEVEL SECURITY;
```

### 问题3：权限不足错误
**症状**：`insufficient privilege` 错误
**原因**：执行用户权限不足
**解决方案**：使用具有足够权限的用户执行，或联系管理员

### 问题4：函数不存在错误
**症状**：`function does not exist` 错误
**原因**：策略引用了不存在的函数
**解决方案**：使用更新后的初始化脚本，已移除不存在的函数引用

## 回退策略

### 策略级回退
如果某个策略有问题，可以单独删除并重新创建：
```sql
-- 删除有问题的策略
DROP POLICY IF EXISTS "策略名称" ON 表名;

-- 重新创建正确的策略
CREATE POLICY "策略名称" ON 表名 ...
```

### 表级回退
如果整个表的策略有问题：
```sql
-- 禁用RLS（临时措施）
ALTER TABLE 表名 DISABLE ROW LEVEL SECURITY;

-- 删除所有策略
DROP POLICY IF EXISTS "策略1" ON 表名;
DROP POLICY IF EXISTS "策略2" ON 表名;
-- ...

-- 重新启用RLS并创建策略
ALTER TABLE 表名 ENABLE ROW LEVEL SECURITY;
-- 重新创建策略...
```

## 版本控制建议

1. **命名规范**：`V{版本号}_{类型}__{描述}.sql`
2. **版本递增**：严格按照版本号递增
3. **文档同步**：每个迁移都要更新此文档
4. **测试验证**：在开发环境充分测试后再应用到生产环境

## 相关文档

- [数据库迁移策略](./DATABASE_MIGRATION_STRATEGY.md)
- [数据库当前状态](./DATABASE_STATE.md)
- [数据库文件说明](../db/README.md)
- [项目贡献指南](../CONTRIBUTING.md)

---

**最后更新**：2025年1月
**维护者**：TodoList开发团队
**状态**：当前版本已同步实际数据库状态