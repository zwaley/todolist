# 团队列表显示问题诊断报告

## 🚨 问题描述

**核心问题：** 被邀请的团队成员在首页看不到自己被邀请加入的团队，只能看到自己创建的团队。

**具体表现：**
- 用户A创建团队并邀请用户B成为成员
- 用户A可以在团队成员列表中看到用户B，也可以删除用户B
- 但用户B登录后，在首页团队列表中看不到用户A创建的团队
- 用户B只能看到自己创建的团队

## 🔍 问题分析

### 1. 当前代码逻辑分析

**文件：** `src/app/[locale]/page.tsx`

**问题代码：**
```typescript
// 第25-37行：获取用户所属团队的查询
const { data: teams, error: teamsError } = await supabase
  .from('team_members')
  .select(`
    teams (
      id,
      name,
      todos (
        id,
        is_completed
      )
    )
  `)
  .eq('user_id', user.id)
```

### 2. 问题根源

**可能的原因：**

1. **RLS策略问题：** `team_members`表的SELECT策略可能不允许用户查询到自己的成员记录
2. **数据完整性问题：** 邀请过程中可能没有正确创建`team_members`记录
3. **查询权限问题：** 用户可能没有权限通过`team_members`表关联查询`teams`表

### 3. 需要检查的关键点

#### 3.1 RLS策略检查
- `team_members`表的SELECT策略是否正确
- 用户是否能查询到自己的成员记录
- 关联查询`teams`表的权限是否正确

#### 3.2 数据完整性检查
- 邀请功能是否正确创建了`team_members`记录
- 数据库中是否存在孤立或重复的记录

#### 3.3 查询逻辑检查
- 首页查询逻辑是否正确
- 是否需要调整查询方式

## 🎯 解决方案

### 方案1：检查并修复RLS策略
1. 验证`team_members`表的SELECT策略
2. 确保用户可以查询到自己的成员记录
3. 修复策略中的权限问题

### 方案2：检查数据完整性
1. 验证邀请功能是否正确创建记录
2. 清理可能的重复或孤立记录
3. 确保数据一致性

### 方案3：优化查询逻辑
1. 简化首页的团队查询
2. 添加错误处理和调试信息
3. 确保查询结果的正确性

## 📋 诊断步骤

### 第一步：验证RLS策略
- 检查当前的RLS策略配置
- 测试用户查询`team_members`表的权限
- 验证关联查询的权限

### 第二步：验证数据完整性
- 检查数据库中的`team_members`记录
- 验证邀请功能的数据创建过程
- 清理可能的数据问题

### 第三步：测试查询逻辑
- 直接测试首页的团队查询
- 添加调试信息
- 验证查询结果

## ⚠️ 风险评估

**影响范围：** 中等
- 影响所有被邀请的团队成员
- 不影响团队创建者
- 不影响团队内部功能

**紧急程度：** 高
- 严重影响用户体验
- 导致功能不可用
- 需要尽快修复

## 📝 修复计划

1. **立即执行：** 诊断RLS策略和数据完整性
2. **短期修复：** 修复发现的策略或数据问题
3. **长期优化：** 改进查询逻辑和错误处理

---

**创建时间：** 2024年12月
**状态：** 待修复
**优先级：** 高